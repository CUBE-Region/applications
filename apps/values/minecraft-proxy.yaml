# yaml-language-server: $schema=https://artifacthub.io/api/v1/packages/25f82b19-62ef-4b43-bbc3-57bbecd5e9d1/3.9.0/values

resources:
  requests:
    memory: 512Mi
    cpu: 100m
  limits:
    memory: 1Gi
    cpu: 500m

affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - k8s-w-edelweiss

minecraftProxy:
  type: VELOCITY
  velocityVersion: 3.4.0-SNAPSHOT
  memory: 512M
  onlineMode: true
  # configFilePath: /server/velocity.toml
  # config: |-
  #   player-info-forwarding-mode = "legacy" # for compatibility with clients that older than 1.13

  #   [servers]
  #   vanilla = "minecraft-cube-vanilla.svc.cluster.local:25565"

  #   [forced-hosts]
  #   "${CFG_VANILLA_PROXY_HOSTNAME}" = ["vanilla"]

extraEnv:
  REPLACE_ENV_VARIABLES: "TRUE"
  CFG_VANILLA_PROXY_HOSTNAME:
    valueFrom:
      secretKeyRef:
        name: minecraft-cube-proxy-secret
        key: vanilla-hostname

minecraftServer:
  serviceType: LoadBalancer
  loadBalancerClass: tailscale

serviceAnnotations:
  tailscale.com/hostname: minecraft-cube-proxy

podSecurityContext:
  runAsUser: 1000
  runAsGroup: 3000
  fsGroup: 2000

initContainers:
  - name: config-setup
    image: busybox:1.35
    command:
      - sh
      - -c
      - |
        cp /config-source/velocity.toml /server/velocity.toml
        chown 1000:2000 /server/velocity.toml
        chmod 644 /server/velocity.toml
    volumeMounts:
      - name: config-source
        mountPath: /config-source
      - name: datadir
        mountPath: /server

extraVolumes:
  - volumes:
      - name: config-source
        configMap:
          name: minecraft-cube-proxy-config
      - name: velocity-forwarding-secret
        mountPath: /server/forwarding.secret
        subPath: forwarding.secret
        readOnly: true
    volumeMounts:
      - name: config-source
        mountPath: /config-source
      - name: velocity-forwarding-secret
        secret:
          secretName: minecraft-cube-proxy-secret
          items:
            - key: velocity-forwarding-secret
              path: forwarding.secret

probes:
  liveness:
    enabled: true
    tcpSocket:
      port: 25565
  readiness:
    enabled: true
    tcpSocket:
      port: 25565

rcon:
  enabled: false
